---
title: "Multi-omics - joint dimensionality reduction"
author: "ejjohnson93"
date: "2022-09-28"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Load libraries

```{r}

library(tidyverse)
library(MOFA2)

```


# Load data

```{r}

# Plasma 
plasma_pheno <- readRDS("./data/plasma_pheno.rds") 
plasma_proteomics_data <- readRDS("./data/plasma_data_norm.rds")
plasma_miRNA_data <- readRDS("./data/plasma_miRNA_data.rds") 
plasma_lncRNA_data <- readRDS("./data/plasma_lncRNA_data.rds")
plasma_snRNA_data <- readRDS("./data/plasma_snRNA_data.rds")

# SF
sf_pheno <- readRDS("./data/sf_pheno.rds")
sf_proteomics_data <- readRDS("./data/sf_data_norm.rds")
sf_miRNA_data <- readRDS("./data/sf_miRNA_data.rds")
sf_lncRNA_data <- readRDS("./data/sf_lncRNA_data.rds")
sf_snRNA_data <- readRDS("./data/sf_snRNA_data.rds")


```


# MOFA

## Plasma

```{r}

colnames(plasma_pheno)[5] <- "sample"

```

```{r}

plasma_mofa_dat <- list(proteomics = as.matrix(plasma_proteomics_data),
                 miRNA = as.matrix(plasma_miRNA_data),
                 lncRNA = as.matrix(plasma_lncRNA_data),
                 snRNA = as.matrix(plasma_snRNA_data))

```


Create MOFAojbect:

```{r}

MOFAobject <- create_mofa(plasma_mofa_dat)
print(MOFAobject)

```


```{r}

plot_data_overview(MOFAobject)

```


Modify model parameters: 

```{r}

# Scale views
data_opts <- get_default_data_options(MOFAobject)
data_opts$scale_views <- TRUE
head(data_opts)


# Set number of factors
model_opts <- get_default_model_options(MOFAobject)
model_opts$num_factors <- 6
head(model_opts)


# Set training options
train_opts <- get_default_training_options(MOFAobject)
train_opts$convergence_mode <- "slow"
head(train_opts)

```


Prepare MOFA object with modified parameters:

```{r}

MOFAobject <- prepare_mofa(
  object = MOFAobject,
  data_options = data_opts,
  model_options = model_opts,
  training_options = train_opts
)

```


Train model:

```{r}

outfile <- file.path(getwd(),"plasma_model.hdf5")
MOFAobject.trained <- run_mofa(MOFAobject, outfile)

```


Add phenotype data to the model:

```{r}

samples_metadata(MOFAobject.trained) <- plasma_pheno

```


Visualise variance explained:

```{r}

plot_variance_explained(
  MOFAobject.trained, 
  x = "view", 
  y = "factor", 
  plot_total = T
)


```

Majority is from proteomics data - likely due to the higher number of features.


Plot correlation between factors:

```{r}

plot_factor_cor(MOFAobject.trained)

```



Correlation between factors and metadata:

```{r}

correlate_factors_with_covariates(MOFAobject.trained, 
  covariates = c("Day", "Horse"), 
  plot="log_pval"
)


```

Factor 1 is correlated with day. Factors 5 and 6 are correlated with horse.



```{r}

plot_top_weights(MOFAobject.trained, 
                  view = "proteomics", 
                  factor = 1, 
                  nfeatures = 5,
                  scale = T, 
                  abs = T
)

```

```{r}

plot_weights(MOFAobject.trained,
 #view = "proteomics",
 factor = 1,
 nfeatures = 15,     # Top number of features to highlight
 scale = T           # Scale weights from -1 to 1
)

```

```{r}

plot_top_weights(MOFAobject.trained, 
                  view = "miRNA", 
                  factor = 2, 
                  nfeatures = 5,
                  scale = T, 
                  abs = T
)

```



```{r}

plot_factors(MOFAobject.trained, 
  factors = c(1,2,3),
  color_by = "Day"
) 

```


```{r}

plot_data_heatmap(MOFAobject.trained, 
  view = "proteomics",
  factor = 1,  
  features = 25,
  cluster_rows = TRUE, cluster_cols = TRUE,
  show_rownames = TRUE, show_colnames = TRUE,
  scale = "row",
  denoise = TRUE
)

```


```{r}

p <- plot_factors(MOFAobject.trained, 
  factors = c(1,2), 
  color_by = "Day",
  shape_by = "Horse",
  dot_size = 2.5,
  show_missing = T
)

p <- p + 
  geom_hline(yintercept=-1, linetype="dashed") +
  geom_vline(xintercept=(-0.5), linetype="dashed")

```
